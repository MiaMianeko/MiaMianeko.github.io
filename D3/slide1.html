<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red List Index Over Time</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .slide {
            display: none; /* Hide all slides by default */
        }
        .slide.active {
            display: block; /* Show active slide */
        }
        .navigation-buttons {
            margin-top: 20px;
        }
        /* Additional styling for the chart labels */
        .label {
            font-size: 12px;
            fill: black;
        }
    </style>
</head>
<body>
<div id="slide1" class="slide active">
    <h2>Red List Index Over Time</h2>
    <label for="country-select-slide1">Select Country:</label>
    <select id="country-select-slide1" class="country-select"></select>
    <label for="year-slider-slide1">Select Year Range:</label>
    <input type="range" id="year-slider-slide1" min="2000" max="2020" step="1" value="2020">
    <div id="chart1"></div>
    <div class="navigation-buttons">
        <!-- No Previous button needed for Slide 1 -->
        <button class="next-slide" data-next-slide="slide2">Next</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const svg1 = d3.select("#chart1").append("svg").attr("width", 800).attr("height", 400);
        const margin1 = { top: 20, right: 30, bottom: 30, left: 40 };
        const width1 = +svg1.attr("width") - margin1.left - margin1.right;
        const height1 = +svg1.attr("height") - margin1.top - margin1.bottom;
        const g1 = svg1.append("g")
            .attr("transform", `translate(${margin1.left},${margin1.top})`);

        // Initialize scales
        const x = d3.scaleTime().rangeRound([0, width1]);
        const y = d3.scaleLinear().rangeRound([height1, 0]);

        const line = d3.line()
            .x(d => x(d.Year))
            .y(d => y(d.Value));

        // Initialize axes
        const xAxis = g1.append("g")
            .attr("transform", `translate(0,${height1})`);

        const yAxis = g1.append("g");

        // Initialize lines
        const indexLine = g1.append("path")
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-width", 1.5);

        const upperLine = g1.append("path")
            .attr("fill", "none")
            .attr("stroke", "red")
            .attr("stroke-width", 1.5);

        const lowerLine = g1.append("path")
            .attr("fill", "none")
            .attr("stroke", "green")
            .attr("stroke-width", 1.5);

        // Initialize labels
        g1.append("text")
            .attr("x", width1 - 150)
            .attr("y", 20)
            .attr("fill", "steelblue")
            .attr("font-size", "12px")
            .text("Index");

        g1.append("text")
            .attr("x", width1 - 150)
            .attr("y", 40)
            .attr("fill", "red")
            .attr("font-size", "12px")
            .text("Upper Bound");

        g1.append("text")
            .attr("x", width1 - 150)
            .attr("y", 60)
            .attr("fill", "green")
            .attr("font-size", "12px")
            .text("Lower Bound");

        // Load data
        d3.csv("./dataset/red_list_index_country_timeseries.csv").then(data => {
            const parseTime = d3.timeParse("%Y");
            updateDropdowns(data, '#country-select-slide1');
            data.forEach(d => {
                d.Year = parseTime(d.Year);
                d.Value = +d.Value; // Convert to number
            });

            function updateChart() {
                const selectedCountry = document.querySelector('#country-select-slide1').value;
                const filteredData = data.filter(d => d.Country === selectedCountry);

                // Update scales
                x.domain(d3.extent(filteredData, d => d.Year));
                y.domain([
                    d3.min(filteredData, d => d['VAR'] === 'LOWER' ? d.Value : Infinity),
                    d3.max(filteredData, d => d['VAR'] === 'UPPER' ? d.Value : -Infinity)
                ]);

                // Update axes
                xAxis.call(d3.axisBottom(x));
                yAxis.call(d3.axisLeft(y));

                // Update lines
                const indexData = filteredData.filter(d => d['VAR'] === 'INDEX');
                const upperData = filteredData.filter(d => d['VAR'] === 'UPPER');
                const lowerData = filteredData.filter(d => d['VAR'] === 'LOWER');

                indexLine
                    .datum(indexData) // Use .datum() for a single line
                    .attr("d", line);

                upperLine
                    .datum(upperData) // Use .datum() for a single line
                    .attr("d", line);

                lowerLine
                    .datum(lowerData) // Use .datum() for a single line
                    .attr("d", line);
            }

            // Initialize chart with default selection
            updateChart();

            // Event listener for dropdown change
            document.querySelector('#country-select-slide1').addEventListener('change', updateChart);

            // Event listener for year slider
            document.getElementById('year-slider-slide1').addEventListener('input', function() {
                const year = +this.value;
                const filteredData = data.filter(d => d.Year.getFullYear() <= year && d.Country === document.querySelector('#country-select-slide1').value);

                // Update domain based on the filtered data
                y.domain([
                    d3.min(filteredData, d => d['VAR'] === 'LOWER' ? d.Value : Infinity),
                    d3.max(filteredData, d => d['VAR'] === 'UPPER' ? d.Value : -Infinity)
                ]);

                indexLine.datum(filteredData.filter(d => d['VAR'] === 'INDEX')).attr("d", line);
                upperLine.datum(filteredData.filter(d => d['VAR'] === 'UPPER')).attr("d", line);
                lowerLine.datum(filteredData.filter(d => d['VAR'] === 'LOWER')).attr("d", line);
            });
        });
    });

    // Function to populate dropdown with country options
    function updateDropdowns(data, selector) {
        const dropdown = d3.select(selector);
        const countries = Array.from(new Set(data.map(d => d.Country))).sort();

        dropdown.selectAll("option")
            .data(countries)
            .enter()
            .append("option")
            .text(d => d)
            .attr("value", d => d);
    }
</script>
</body>
</html>
