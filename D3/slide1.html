<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .slide {
            display: none; /* Hide all slides by default */
        }
        .slide.active {
            display: block; /* Show active slide */
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: 200px;
            height: auto;
            padding: 5px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
        }
        .line {
            stroke-width: 3; /* Increase line thickness */
        }
        .line.hover {
            stroke-width: 4; /* Increase thickness on hover */
        }
        .line.hover-area {
            stroke: none; /* Make interactive area invisible */
            fill: none; /* Ensure interactive area is invisible */
            pointer-events: all; /* Make interactive area selectable */
        }
        .hover-line {
            stroke-dasharray: 5, 5; /* Make line dotted */
        }
        .legend rect {
            stroke-width: 1px;
        }

        .legend text {
            font-size: 12px;
            text-anchor: start;
        }
        /* General styles for dropdown */
        .country-select {
            appearance: none; /* Remove default browser styling */
            -webkit-appearance: none;
            -moz-appearance: none;
            border: 1px solid #ccc; /* Border color */
            border-radius: 4px; /* Rounded corners */
            background-color: #f9f9f9; /* Background color */
            color: #333; /* Text color */
            padding: 10px; /* Padding inside the dropdown */
            font-size: 14px; /* Font size */
            width: 200px; /* Width of the dropdown */
            cursor: pointer; /* Pointer cursor on hover */
            outline: none; /* Remove default outline */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Add shadow */
            transition: all 0.3s ease; /* Smooth transition for hover effect */
        }

        /* Dropdown arrow */
        .country-select::-ms-expand {
            display: none; /* Hide default dropdown arrow in Internet Explorer */
        }

        /* Style for dropdown when hovered */
        .country-select:hover {
            border-color: #888; /* Darker border color on hover */
        }

        /* Style for dropdown when focused */
        .country-select:focus {
            border-color: #007bff; /* Change border color when focused */
            box-shadow: 0 0 0 0.2rem rgba(38, 143, 255, 0.25); /* Focus shadow */
        }
        .title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0; /* Adjusted margin to bring the title closer to the SVG */
            padding: 10px; /* Optional: Add padding if needed for better spacing */
        }
        .container {
            display: flex; /* Use Flexbox to layout items */
            align-items: flex-start; /* Align items at the top */
            gap: 20px; /* Space between chart and description */
            margin: 20px; /* Margin around the container */
        }
        .description {
            width: 400px; /* Increase width for more space */
            font-size: 18px; /* Increase font size for better readability */
            line-height: 1.8; /* Increase line height for improved readability */
            padding: 20px; /* Increase padding for more space inside the box */
            background-color: #f9f9f9;
            border: 1px solid #d3d3d3;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);/* Add a shadow for better visibility */
        }

    </style>

</head>
<body>
<div id="slide1" class="slide active">
    <h2>Red List Index Over Time</h2>
    <div class="line-container">
    <label for="country-select-slide1">Select Country:</label>
    <select id="country-select-slide1" class="country-select"></select>
        <div class="container">
            <div id="chart1"></div>
    <div class="description">
        This chart displays the Red List Index for selected countries over time. The Red List Index measures the extinction risk of species, with different lines representing the Index, Upper Bound, and Lower Bound values.
        <br><br>
        <strong>How to Use:</strong>
    <ul>
        <li>Select a country from the dropdown menu to view its Red List Index data.</li>
        <li>The chart shows three lines: <strong>Index</strong> (overall trend), <strong>Upper Bound</strong> (highest estimate), and <strong>Lower Bound</strong> (lowest estimate).</li>
        <li>Hover over the chart to see detailed values for each year, including the Index, Upper, and Lower Bound values.</li>
    </ul>
    </div>
    </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const svg1 = d3.select("#chart1").append("svg").attr("width", 900).attr("height", 400);
        const margin1 = { top: 20, right: 100, bottom: 30, left: 40 };
        const width1 = +svg1.attr("width") - margin1.left - margin1.right;
        const height1 = +svg1.attr("height") - margin1.top - margin1.bottom;
        const g1 = svg1.append("g")
            .attr("transform", `translate(${margin1.left},${margin1.top})`);

        // Initialize scales
        const x = d3.scaleTime().rangeRound([0, width1]);
        const y = d3.scaleLinear().rangeRound([height1, 0]);

        const line = d3.line()
            .curve(d3.curveBasis) // Apply the curveBasis interpolation method
            .x(d => x(d.Year))
            .y(d => y(d.Value));

        // Initialize axes
        const xAxis = g1.append("g")
            .attr("transform", `translate(0,${height1})`);

        const yAxis = g1.append("g");

        // Initialize lines with Category10 color scheme
        const colors = d3.schemeCategory10;
        const indexLine = g1.append("path")
            .attr("class", "line")
            .attr("fill", "none")
            .attr("stroke", colors[0]);

        const upperLine = g1.append("path")
            .attr("class", "line")
            .attr("fill", "none")
            .attr("stroke", colors[1]);

        const lowerLine = g1.append("path")
            .attr("class", "line")
            .attr("fill", "none")
            .attr("stroke", colors[2]);

        // Add invisible interactive areas
        g1.append("path")
            .attr("class", "line hover-area")
            .attr("fill", "none")
            .attr("stroke", "none")
            .attr("pointer-events", "all");

        // Add vertical hover line
        const hoverLine = g1.append("line")
            .attr("class", "hover-line")
            .attr("stroke", "black")
            .attr("stroke-width", 1)
            .style("opacity", 0); // Hide initially

        // Create legend
        const legend = svg1.append("g")
            .attr("class", "legend")
            .attr("transform", `translate(${width1 + margin1.right - 50}, ${margin1.top})`);

        const legendData = [
            { label: "Index", color: colors[0] },
            { label: "Upper Bound", color: colors[1] },
            { label: "Lower Bound", color: colors[2] }
        ];

        legend.selectAll("rect")
            .data(legendData)
            .enter()
            .append("rect")
            .attr("x", 0)
            .attr("y", (d, i) => i * 20)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", d => d.color);

        legend.selectAll("text")
            .data(legendData)
            .enter()
            .append("text")
            .attr("x", 24)
            .attr("y", (d, i) => i * 20 + 9)
            .attr("dy", "0.35em")
            .text(d => d.label);

        // Add tooltip
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Load data
        d3.csv("./dataset/red_list_index_country_timeseries.csv").then(data => {
            const parseTime = d3.timeParse("%Y");
            updateDropdowns(data, '#country-select-slide1');
            data.forEach(d => {
                d.Year = parseTime(d.Year);
                d.Value = +d.Value; // Convert to number
            });

            function updateChart() {
                const selectedCountry = document.querySelector('#country-select-slide1').value;
                const filteredData = data.filter(d => d.Country === selectedCountry);

                // Update scales
                x.domain(d3.extent(filteredData, d => d.Year));
                y.domain([
                    d3.min(filteredData, d => d['VAR'] === 'LOWER' ? d.Value : Infinity),
                    d3.max(filteredData, d => d['VAR'] === 'UPPER' ? d.Value : -Infinity)
                ]);

                // Update axes
                xAxis.call(d3.axisBottom(x));
                yAxis.call(d3.axisLeft(y));

                // Update lines
                const indexData = filteredData.filter(d => d['VAR'] === 'INDEX');
                const upperData = filteredData.filter(d => d['VAR'] === 'UPPER');
                const lowerData = filteredData.filter(d => d['VAR'] === 'LOWER');

                indexLine
                    .datum(indexData) // Use .datum() for a single line
                    .attr("d", line);

                upperLine
                    .datum(upperData) // Use .datum() for a single line
                    .attr("d", line);

                lowerLine
                    .datum(lowerData) // Use .datum() for a single line
                    .attr("d", line);

                // Update interactive areas
                g1.select(".hover-area")
                    .datum(indexData.concat(upperData).concat(lowerData))
                    .attr("d", d => line(d))
                    .style("pointer-events", "all");

                // Add mouse event listeners
                g1.on("mouseover", function(event) {
                    const mouse = d3.pointer(event);
                    const xPos = mouse[0];

                    // Find nearest data points
                    const nearestIndexPoint = indexData.reduce((prev, curr) =>
                        Math.abs(x(curr.Year) - xPos) < Math.abs(x(prev.Year) - xPos) ? curr : prev
                    );
                    const nearestUpperPoint = upperData.reduce((prev, curr) =>
                        Math.abs(x(curr.Year) - xPos) < Math.abs(x(prev.Year) - xPos) ? curr : prev
                    );
                    const nearestLowerPoint = lowerData.reduce((prev, curr) =>
                        Math.abs(x(curr.Year) - xPos) < Math.abs(x(prev.Year) - xPos) ? curr : prev
                    );

                    // Update vertical line position
                    hoverLine
                        .attr("x1", xPos)
                        .attr("x2", xPos)
                        .attr("y1", 0)
                        .attr("y2", height1)
                        .style("opacity", 1); // Show line on hover

                    // Update tooltip
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`
                        Year: ${d3.timeFormat("%Y")(nearestIndexPoint.Year)}<br>Value (Index): ${nearestIndexPoint.Value}<br>
                        Value (Upper): ${nearestUpperPoint.Value}<br>Value (Lower): ${nearestLowerPoint.Value}
                    `)
                        .style("left", `${event.pageX + 5}px`)
                        .style("top", `${event.pageY - 28}px`);
                }).on("mousemove", function(event) {
                    const mouse = d3.pointer(event);
                    const xPos = mouse[0];

                    // Update vertical line position
                    hoverLine
                        .attr("x1", xPos)
                        .attr("x2", xPos);

                    // Update tooltip position
                    tooltip.style("left", `${event.pageX + 5}px`)
                        .style("top", `${event.pageY - 28}px`);
                }).on("mouseout", function() {
                    // Hide tooltip and vertical line
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                    hoverLine
                        .attr("x1", 0)
                        .attr("x2", 0);
                });
            }

            // Update chart when country selection changes
            document.querySelector('#country-select-slide1').addEventListener('change', updateChart);

            // Initial chart update
            updateChart();
        });

        function updateDropdowns(data, selector) {
            const select = d3.select(selector);
            const countries = Array.from(new Set(data.map(d => d.Country)));
            select.selectAll("option")
                .data(countries)
                .enter()
                .append("option")
                .attr("value", d => d)
                .text(d => d);
        }

    });
</script>
</body>
</html>
